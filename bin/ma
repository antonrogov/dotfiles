#!/bin/zsh

MAIL_DIR=$XDG_DATA_HOME/mail
export NOTMUCH_CONFIG=$XDG_CONFIG_HOME/notmuch/config

exec_gmi() {
  source $MAIL_DIR/.env/bin/activate

  if test -t 0; then
    exec gmi "${@}" -C $MAIL_DIR
  else
    exec gmi "${@}" -C $MAIL_DIR > "$MAIL_DIR/.env/log" 2>&1
  fi
}

case "$1" in
  fmt)
    file="$2"
    if [[ "$file" == *".html" ]]; then
      exec links -html-numbered-links 1 -dump "$file"
    else
      exec iconv -f utf-8 -t utf-8//ignore "$file" | sed -E '1h;2,$H;$!d;g;s/([ \t]*\n){3,}/\n\n/g'
    fi
    ;;

  sync)
    exec_gmi sync "${@:2}"
    ;;

  send)
    exec_gmi send -t
    ;;

  *)
    if [[ "$@" == "" ]]; then
      neomutt
      printf "\e[?25h" # show the cursor
    else
      exec neomutt "$@"
    fi
    ;;
esac
